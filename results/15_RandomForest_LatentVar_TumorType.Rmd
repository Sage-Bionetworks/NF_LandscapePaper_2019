---
title: "RF_latent_variable"
author: "Jineta Banerjee"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    toc: true
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    fig_width: 7
    fig_height: 6
    fig_caption: true
    df_print: paged
    code_folding: hide
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, echo=FALSE, eval=TRUE, results='hide', message=FALSE, warning=FALSE, include=FALSE}

library(synapser)
library(synapserutils)
library(BiocManager)
library(gProfileR)
library(GOsummaries)
library(tidyverse)
library(DT)
library(magrittr)
library(colorspace)
library(RColorBrewer)

#Random Forest
library(randomForest)
library(e1071)
library(caret)

#plotting
library(AppliedPredictiveModeling)
transparentTheme(trans = .4)
library(pheatmap)

library(AnnotationDbi)
#library(hgu95av2.db)
#library(STRINGdb)
library(gridExtra)

#Synapser
synLogin()
```

## Introduction

This document describes training a random forest model using laten variables generated by transfer learning approaches. We are using the latent variables found in pNF and MPNST data to train the forest to find the most important classifiers for these two tumor types. We chose to train a random forest classifier to identify NF tumortypes for the following features of the model :
* robustness to high dimensinality data
* ability to handle unbalanced classes
* robustness to outliers and non-linear data
* quick training /prediction speeds
* low bias and moderate variance

Our goal is to find important latent variables that classify the various tumorTypes. We will then inspect the classifying features to find meaningful genesets that distinguish between two tumortypes.

Tumortypes represented in the data:
* Plexiform Neurofibroma
* MPNST

```{r download data from Synapse, echo=FALSE, eval=TRUE}

#download LV data:
lv_entity <- synGet("syn18689545")
lv_all_pn <- readRDS(lv_entity$path)
gene_by_lv <- as.data.frame(lv_all_pn$Z)
recount_sample_by_lv <- as.data.frame(lv_all_pn$B)

lv_by_NF <- synTableQuery("SELECT * FROM syn21046991")$asDataFrame() 
keep <- c("latent_var", "value", "specimenID")
lv_by_NF_select <- lv_by_NF[ ,keep] %>%
  group_by_at(vars(-value)) %>%  # group by everything other than the value column.
  mutate(row_id=1:n()) %>% ungroup() %>%  # build group index
  spread(key=latent_var, value=value) %>%    # spread
  dplyr::select(-row_id)   # drop the index 

specimen_tumortype <- unique(lv_by_NF[,c("specimenID", "tumorType")])

forest_data <- merge(lv_by_NF_select, specimen_tumortype, by = "specimenID")
rownames(forest_data) <- forest_data$specimenID
forest_data$tumorType <- as.factor(forest_data$tumorType)
forest_data <- forest_data[(forest_data$tumorType != "NA"),!(colnames(forest_data) %in% c("specimenID"))]

levels(forest_data$tumorType) <- factor(forest_data$tumorType)

```


## Partitioning the data into training and testing set:

The resulting filtered dataset was then split into 75% training and 25% testing dataset. The function _createDataPartition_ is used to create balanced splits of the data. Since the _tumorType_ argument to this function is a factor, the random sampling occurs within each class and should preserve the overall class distribution of the data.

```{r split the data for training, echo=FALSE, eval=TRUE}

#Make the test and training datasets
set.seed(998)
inTraining <- createDataPartition(forest_data$tumorType, p = .75, list = FALSE)

training <- forest_data[ inTraining,]
rownames(training) <- training$Tumor_Sample_Barcode
levels(training$tumorType) <- factor(training$tumorType)

testing  <- forest_data[-inTraining,]
rownames(testing) <- testing$Tumor_Sample_Barcode
levels(testing$tumorType) <- factor(testing$tumorType)
```

## Model training and Crossvalidation :

We then trained the model on the training dataset using iterative _mtrys_ and 500 trees. The model was crossvalidated using 10-fold corssvalidation technique. The details of the model are described below.

```{r create random forest caret, echo=FALSE, eval=TRUE, fig.height=8, fig.width=8}

# 10 fold validation control
fitControl <- trainControl(## 10-fold CV
                           method = "repeatedcv",
                           number = 10,
                           ## repeated ten times
                           repeats = 10)



# Construct the random forest model called Fit #length(colnames(trainTransformed)
set.seed(998)
Fit <- train(tumorType ~ ., data = training[,c(1:length(colnames(training)))], 
                 method = "rf", 
                 ntree= 500, 
                 #mtry=10,
                 #classwt = c(1E5,1E3,1E3,1E3,1E-5,1E5),
                 proximity=TRUE,
                 importance = TRUE,
                 trControl = fitControl, 
                 verbose = TRUE) 
                 ## Now specify the exact models 
                 ## to evaluate:

print(" Check the fit of the model")                 
Fit
#png("LV_NF_noglioma.png", height=500, width=1500)
#grid.table(Fit$finalModel$confusion)

#plot the model
#trellis.par.set(caretTheme())
#plot(Fit, metric = "Kappa")

#plot the model
plot(Fit,
     ylim = c(0,1),
     main= "The model",
     cex.main = 5, 
     cex.lab = 5,
     cex.axis = 5)

print("Check the sizes of trees in the model")
hist(treesize(Fit$finalModel))

print("Check the clustering of the samples accoriding to the model")
MDSplot(Fit$finalModel, as.factor(training$tumorType), 
        k=2, palette=NULL, pch=as.numeric(training$tumorType), main= "MDS Plot of the classified training set")
legend("topright",inset=0.01, legend=levels(training$tumorType), fill=brewer.pal(6, "Set1"))

```


```{r predict model, echo=FALSE, eval=TRUE}

#Use model to predict labels of test data
pred <- predict(Fit, newdata = testing[,c(1:length(colnames(testing)))])

#store predicted labels in the test dataframe
testing$pred <- pred

```

## Check the quality of prediction

The confusion matrix of the prediction using the model is given below.
```{r model accuracy, echo=FALSE, eval=TRUE}

# Check the accuracy of the model
library(DT)

conf_matrix <- confusionMatrix(data = testing$pred, 
                              reference = as.factor(testing$tumorType), 
                              mode = "prec_recall")
conf_matrix$table
#library(gridExtra)
#png("data_output_NF_Lvs_pNF_and_MPNST.png", height=500, width=1500)
#grid.table(conf_matrix$table)
#dev.off()

```

## Visualizing the predictors of the model:

```{r visualize predictor feature set, echo=FALSE, eval=TRUE, fig.width=20, fig.height=20}

# estimate variable importance
importance <- varImp(Fit, scale=FALSE)

# summarize importance
#print(importance)

# plot importance
# plot(importance,
#      main = "Important variables in the forest")
varImpPlot(Fit$finalModel,
           main = "Important variables in the forest",
           n.var = 20)

#Partial dependence plot
#partialPlot(Fit$finalModel, Fit$trainingData, Fit$trainingData$KLF9)

#getTree(Fit$finalModel, k=2, labelVar=TRUE)

#Find correlated genes from correlation matrix
#corr_matrix <- as.data.frame(corred_data)

# #Plot the expression of a specific important feature
# ggplot(data=testing)+
#   geom_boxplot(aes(x= as.factor(tumorType), y= HPS3))+
#   ylim(c(-1,2))+
#     ggpubr::rotate_x_text()+
#     ggtitle(paste('zScore of predictor in various tumorTypes'))

# Select top important features
list <- as.data.frame(importance$importance)
MPNST_list <- list[order(-list$`Malignant Peripheral Nerve Sheath Tumor`), ]
pNF_list <- list[order(-list$`Plexiform Neurofibroma`), ]


## Add genes names to plotting df
MPNST_list$LV <- rownames(MPNST_list)
MPNST_list$LV <- gsub("`", "", MPNST_list$LV)

##Funtion to extract umbers from data
library(stringr)
numextract <- function(string){ 
  str_extract(string, "\\-*\\d+\\.*\\d*")
} 

MPNST_list$LatentVar <- numextract(MPNST_list$LV)
# #Add LV to each Latentvar
# library(glue)
# MPNST_list$LatentVar <- glue('V{MPNST_list$LatentVar}')
# 
# keep <- c(colnames(gene_by_lv) %in% MPNST_list$LatentVar[1:20])
# plot_data <- gene_by_lv[,keep]
# plot_data$Hugo_Symbol <- rownames(plot_data)

keep <- c(colnames(forest_data) %in% MPNST_list$LV[1:50])
plot_data <- forest_data[ , keep]
plot_data$tumorType <- forest_data$tumorType
plot_data$specimenID <- rownames(plot_data)

#png("LV_Heatmap_pNF_and_MPNST.png", height=1500, width=1500)
pheatmap(plot_data[,1:50],
                       show_rownames = F,
                       labels_col = colnames(plot_data)[1:50],
                       #fontsize_row = 0,
                       clustering_method = 'ward.D2',
                       cluster_rows = T,
                       scale = "column",
                       #annotation_col = colnames(plot_data),
                       annotation_row= plot_data[,c("specimenID", "tumorType")],
         #margins =c(12,12))
                       width = 8, 
                       height = 8)
#dev.off()
```
