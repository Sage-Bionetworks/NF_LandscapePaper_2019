---
title: "Tumor type association with latent variable expression in NF tumors"
author: "Robert Allaway"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```


Here, we are evaluating the expression of latent variables in NF tumors as they pertain to the type of the tumor. These data were generated as part of developing the braiNFood app. 

# Import packages

First, import packages to process and plot the data. 


```{r message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(purrr)
library(synapser)
synLogin()
library(clusterProfiler)

plier_model <- readr::read_rds(synGet("syn18689545")$path)

plier_loadings_df <- plier_model$Z %>% as.data.frame() %>% purrr::set_names(rownames(plier_model$B))

drug_targets <- feather::read_feather(synGet('syn20700199')$path)

drug_targets <- drug_targets %>% 
  filter(mean_pchembl > 7) %>% 
  mutate(gene= hugo_gene) %>% 
  select(gene, std_name) 
```

# Significance testing

We already have the expression of the latent variables in these tumors. Let's filter out low variance samples. 

Then, we perform a kruskall-wallis test and adjust the resulting p-value based on the expression of a latent variable as a function of the sex of the patient the sample was taken from. 

Then we take the tidy data frame of latent variable data, group by the variable and tumor type, nest the dataframe based on those groups, and then calculate the p-value for each nested data frame. Finally, we plot a boxplot for any latent variable where the BH-adjusted p-value is <0.1 when comparing female to male tumors. 

In addition, we'll also do this analysis between the two sexes without regard for the tumor type to see if there are any consistent differences when the type of tumor is not a factor. 

```{r message=FALSE, warning=FALSE}

term2gene <- drug_targets %>% 
  rename(term = std_name) %>% 
  mutate(term = 'all_drugs') %>% 
  distinct()

tidy <- plier_loadings_df %>% 
      tibble::rownames_to_column('gene') %>%
  gather(lv, loading, -gene) %>% 
  filter(loading > 0) %>% 
  group_by(lv) %>% 
  filter(loading > quantile(loading, 0.95)) %>% 
  nest() %>% 
  mutate(data = lapply(data, function(x){
    geneList <- x$loading 
    names(geneList) <- as.character(x$gene) 
    geneList <- sort(geneList, decreasing = TRUE)
    geneList
  }))

tidy_2 <- tidy %>%
  mutate(data = sapply(data, function(x){
   tryCatch(GSEA(geneList = x, TERM2GENE = term2gene), error=function(err) NA)
 }))


x <- tidy[[2]][[2]]

GSEA(x, minGSSize = 1, maxGSSize = 5000, TERM2GENE = term2gene)

```


```{r}

sessionInfo()
```
