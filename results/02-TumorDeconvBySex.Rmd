---
title: "02-Immune Sex Differences"
author: "Sara Gosline"
date: "10/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(synapser)
synLogin()
require(tidyverse)
```

## Introduction
This is a first stab at checking immune annotation predictions to see if the presence/absence of immune cells is any different between sexes.

First get the tumor de-convolution results for NF1 tumors from synapse, combine non-standard tumor types and handle basic renaming of variables.
```{r,warning=FALSE}
tab<-synapser::synTableQuery("select * from syn20710536")$asDataFrame()

tab<-subset(tab,diagnosis=='Neurofibromatosis 1')

tab$tumorType[which(tab$tumorType%in%c("Ependymoma","Ganglioglioma"))]<-'Other'

tab$tumorType[which(tab$tumorType=="Malignant peripheral nerve sheath tumor")]<-"Malignant Peripheral Nerve Sheath Tumor"
```

## Check tumor-specific sex differences
```{r}
##now what do we see on a tissue level? 
res.c<-tab%>%subset(tumorType!='Other')%>%subset(method!='xcell')%>%
  spread(key=sex,value=score)%>%
  group_by(method,tumorType,cell_type)%>%
  mutate(pval=t.test(female,male)$p.value)%>%
  select(method,cell_type,pval,tumorType)%>%distinct()%>%
  group_by(method)%>%
  mutate(correctedP=p.adjust(pval))

sigs<-subset(res.c,pval<0.05)
sigs
```

There are numerous significant cell-type/tumor combinations.
```{r}
for(ct in unique(sigs$cell_type)){
  sigs.t=subset(sigs,cell_type==ct)
#  for(tu in unique(sigs$tumorType)){
  tab.t=subset(tab,tumorType%in%sigs.t$tumorType)%>%subset(cell_type==ct)
    
  #  tab.p<-subset(tab.t,method==meth)%>%subset(cell_type%in%(sigs.t$cell_type))
 p<-ggplot(tab.t,palette='jco')+geom_boxplot(aes(x=cell_type,fill=sex,y=score))+facet_grid(.~tumorType)+ theme(axis.text.x = element_text(angle = 90, hjust = 1))
 # p<-ggboxplot(subset(tab.t,cell_type=='Neutrophil'),x='tumorType',y='score',color='sex',palette='jco')+stat_compare_means(method='t.test')+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
  print(p)

  
}

```
There are some interesting tumor-specific differences, primarily in cNFs, but also some in MPNSTs (with their lone male)

```{r,warning=FALSE}
library(ggpubr)
res<-tab%>%spread(key=sex,value=score)%>%
  group_by(method,cell_type)%>%
    mutate(pval=t.test(female,male)$p.value)%>%
  select(method,cell_type,pval)%>%distinct()%>%
  group_by(method)%>%
  mutate(correctedP=p.adjust(pval))


sigs<-subset(res,pval<0.05)
sigs
```
More significant pathways, we can try to  plot them

```{r}

for(meth in unique(tab$method)){
  tab.p<-subset(tab,method==meth)%>%subset(cell_type%in%(sigs$cell_type))

  p<-ggboxplot(tab.p,x='sex',y='score',facet.by='cell_type',color='sex',palette='jco')+stat_compare_means(method='t.test')
  print(p)
}

```  

